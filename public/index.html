<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />

    <!-- This is an SEO Change -->
    <meta
      name="description"
      content="Personal Budget app to manage expenses, track results, and stay on budget. Free and simple to use."
    />

    <!-- This is an SEO Change -->
    <meta
      name="keywords"
      content="budget, personal finance, money management, expense tracker"
    />

    <!-- This is an SEO Change -->
    <meta name="author" content="Vatsal Upadhyay" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Personal Budget - Manage Your Expenses</title>
    <link rel="stylesheet" href="reset.css" />
    <link rel="stylesheet" href="main.css" />
  </head>
  <body>
    <!-- This is a Semantic HTML Change -->
    <header>
      <nav class="menu" aria-label="Main Navigation">
        <ul>
          <li><a href="/">Homepage</a></li>
          <li><a href="/about.html">About</a></li>
          <li><a href="/login.html">Login</a></li>
          <li><a href="https://google.com">Google</a></li>
        </ul>
      </nav>
    </header>

    <!-- This is a Semantic HTML Change -->
    <main id="main-content">
      <section class="hero">
        <h1>Personal Budget</h1>
        <h2>A personal-budget management app</h2>
      </section>

      <section class="page-area">
        <article class="text-box">
          <h2>Stay on track</h2>
          <p>
            Do you know where you are spending your money? If you really stop to
            track it down, you would get surprised! Proper budget management
            depends on real data... and this app will help you with that!
          </p>
        </article>

        <article class="text-box">
          <h2>Alerts</h2>
          <p>
            What if your clothing budget ended? You will get an alert. The goal
            is to never go over the budget.
          </p>
        </article>

        <article class="text-box">
          <h2>Results</h2>
          <p>
            People who stick to a financial plan, budgeting every expense, get
            out of debt faster! Also, they live happier lives... since they
            expend without guilt or fear... because they know it is all good and
            accounted for.
          </p>
        </article>

        <article class="text-box" id="chart-card">
          <h2>chart</h2>
          <canvas
            id="myChart"
            width="300"
            height="300"
            aria-label="Budget Pie Chart"
            role="img"
          ></canvas>
        </article>

        <article class="text-box" id="d3js-card">
          <h2>D3JS Chart</h2>
          <div id="d3-chart"></div>
        </article>
      </section>
    </main>

    <!-- This is a Semantic HTML Change + A11y Change -->
    <footer class="bottom">
      <div class="center">
        <!-- This is an A11y Change -->
        <p aria-label="All rights reserved message">
          All rights reserved &copy; Fabio Nolasco
        </p>
      </div>
    </footer>

    <!-- This is an A11y Change -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.11.0/axios.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script>
      var dataSource = {
        labels: [],
        datasets: [
          {
            data: [],
            backgroundColor: []
          }
        ]
      };

      function createChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        if (window._budgetChart) {
          window._budgetChart.destroy();
        }
        window._budgetChart = new Chart(ctx, {
          type: 'pie',
          data: dataSource,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top'
              }
            }
          }
        });
      }

      function getBudget() {
        axios.get('/data').then(function (res) {
          for (var i = 0; i < res.data.myBudget.length; i++) {
            const item = res.data.myBudget[i];
            dataSource.datasets[0].data[i] = item.value ?? item.budget;
            dataSource.labels[i] = item.title;
            dataSource.datasets[0].backgroundColor[i] = item.color || '#cccccc';
          }
          createChart();
        }).catch(function (err) {
          console.error('Failed to load budget data:', err);
        });
      }

      getBudget();

    d3.json('/data').then(function (data) {
        const margin = { top: 20, right: 20, bottom: 90, left: 50 };
        const outerWidth = 600;
        const outerHeight = 380;
        const width = outerWidth - margin.left - margin.right;
        const height = outerHeight - margin.top - margin.bottom;

        d3.select('#d3-chart').selectAll('*').remove();

        const svg = d3
          .select('#d3-chart')
          .append('svg')
          .attr('width', outerWidth)
          .attr('height', outerHeight)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3
          .scaleBand()
          .domain(data.myBudget.map((d) => d.title))
          .range([0, width])
          .padding(0.15);

        const y = d3
          .scaleLinear()
          .domain([0, d3.max(data.myBudget, (d) => d.value ?? d.budget)])
          .nice()
          .range([height, 0]);

        svg
          .selectAll('rect')
          .data(data.myBudget)
          .enter()
          .append('rect')
          .attr('x', (d) => x(d.title))
          .attr('y', (d) => y(d.value ?? d.budget))
          .attr('width', x.bandwidth())
          .attr('height', (d) => height - y(d.value ?? d.budget))
          .attr('fill', (d) => d.color || 'steelblue');

        const xAxis = svg
          .append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x));

        xAxis
          .selectAll('text')
          .style('text-anchor', 'end')
          .attr('dx', '-0.6em')
          .attr('dy', '0.15em')
          .attr('transform', 'rotate(-45)');

        svg.append('g').call(d3.axisLeft(y));
      });
    </script>
  </body>
</html>
